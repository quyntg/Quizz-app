<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Đề thi trắc nghiệm</title>
        <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
        <script src="../data/data.js"></script>
        <script src="../js/script.js"></script>
        <style>
            .option-correct {
                background: #d4f7dc !important;
                border: 2px solid #00b894 !important;
                color: #218c5a !important;
                font-weight: bold;
            }
            .option-user {
                background: #ffe6e6 !important;
                border: 2px solid #d63031 !important;
                color: #d63031 !important;
                font-weight: bold;
            }
            .option-correct-empty {
                background: #fff9d6 !important;
                border: 2px solid #f7b731 !important;
                color: #b8860b !important;
                font-weight: bold;
            }
            .option-correct {
                background: #d4f7dc !important;
                border: 2px solid #00b894 !important;
                color: #218c5a !important;
                font-weight: bold;
            }
            .option-user {
                background: #ffe6e6 !important;
                border: 2px solid #d63031 !important;
                color: #d63031 !important;
                font-weight: bold;
            }
            body {
                background: #f5f7fa;
                margin: 0;
                padding: 20px;
            }

            .exam-container {
                max-width: 800px;
                margin: 20px auto;
                background: #fff;
                padding: 18px 16px 18px 16px;
                border-radius: 12px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.12);
                color: #222;
            }

            .exam-header-block {
                max-width: 90%;
                margin: auto;
                margin-bottom: 32px;
                font-size: 16px;
                color: #2c3e50;
            }

            .header-columns {
                display: flex;
                justify-content: space-between;
                flex-wrap: wrap;
                margin-bottom: 18px;
            }

            .header-left, .header-right {
                width: 48%;
                line-height: 1.6;
            }
            .header-left { text-align: left; }
            .header-right { text-align: right; }

            .student-info p {
                margin: 6px 0;
                font-size: 15px;
            }

            .exam-instruction {
                margin-top: 18px;
                text-align: justify;
                font-size: 15px;
            }

            .question {
                padding-bottom: 16px;
            }
            .question p {
                margin: 0 0 10px;
                color: #2c3e50;
                font-size: 17px;
            }
            .options {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .options li {
                margin-bottom: 8px;
                padding: 10px 16px;
                background: #f8f9fa;
                border-radius: 6px;
                font-size: 16px;
                color: #222;
                border: 1px solid #e0e0e0;
                transition: background 0.3s, border 0.3s;
                margin-left: 28px;
            }
            .options li:hover {
                background: #e3eafc;
                border: 1px solid #b2bec3;
            }
            .btn-download {
                display: inline-block;
                margin-top: 32px;
                padding: 12px 28px;
                background-color: #3498db;
                color: #fff;
                text-decoration: none;
                border-radius: 7px;
                font-size: 17px;
                border: none;
                cursor: pointer;
                box-shadow: 0 2px 6px rgba(52,152,219,0.08);
                transition: background 0.2s;
            }
            .btn-download:hover {
                background-color: #217dbb;
            }

            .header-left p,
            .header-right p {
                text-align: center;
            }

            * {
                box-sizing: border-box;
            }

            .question, .exam-header-block {
                page-break-inside: avoid;
            }

            .bailam-title {
                text-align: center;
                font-size: 20px !important;
                font-weight: bold;
                margin: 18px 0 10px 0 !important;
                letter-spacing: 2px;
            }

            @media print {
                body {
                    print-color-adjust: exact;
                }
                body, .exam-container {
                    background: #fff !important;
                    color: #000 !important;
                    box-shadow: none !important;
                }
                .btn-download {
                    display: none !important;
                }
                .exam-container {
                    padding: 0 !important;
                    margin: 0 !important;
                }
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body>
        <button class="btn-download" onclick="downloadPDF()">Tải về PDF</button>
        <div id="modalLoading" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 999; align-items: center; justify-content: center; ">
            <div style="background: #fff; padding: 24px 32px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.15); font-size: 1.2rem; color: #333; display: flex; flex-direction: column; align-items: center; ">
                <div class="spinner" style="border: 4px solid #eee; border-top: 4px solid #2c7be5; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; margin-bottom: 12px; "></div>
                <span>Đang tải bài làm...</span>
            </div>
        </div>
        <div id="exam-content" class="exam-container" style="display:none;">
            <div class="exam-header-block">
                <div class="header-columns">
                    <div class="header-left">
                        <p>
                            <strong>BỘ GIÁO DỤC VÀ ĐÀO TẠO</strong>
                            <br> Trường <span id="schoolForm"></span>
                        </p>
                    </div>
                    <div class="header-right">
                        <p>
                            <strong>ĐỀ KIỂM TRA</strong>
                            <br> Môn: <strong><span id="subjectForm"></span></strong>
                            <br>
                            <em>Thời gian làm bài: <span id="timeForm"></span> phút 
                            <br>(không kể thời gian phát đề)</em>
                        </p>
                    </div>
                </div>
                <div class="student-info">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <p><strong>Họ, tên học sinh:</strong> <span id="studentNameForm"></span></p>
                            <p><strong>Lớp:</strong> <span id="studentClassForm"></span></p>
                        </div>
                        <div id="pointView" style="text-align: right; padding-right: 20%; font-size: 18px; font-weight: bold;color: #00b894; display: none;">
                            Điểm: <span id="studentPoint"></span>
                        </div>
                    </div>
                    <p class="bailam-title">BÀI LÀM</p>
                </div>
            </div>
            <div id="list-question"></div>
        </div>
        <!-- Thư viện html2pdf -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <script>            
            const time = localStorage.getItem('examTime') || '';
            const school = localStorage.getItem('school') || '';
            const isViewResult = localStorage.getItem('isViewResult');
            let examName = '';

            let subject = '';
            const subjectSelect = localStorage.getItem('subject') || '';
            if (subjectSelect) {
                subjects.forEach(sub => {
                    if (sub.value === subjectSelect) {
                        subject = sub.text;
                    }
                });
            }
            document.getElementById('timeForm').textContent = time;
            document.getElementById('subjectForm').textContent = subject;
            document.getElementById('schoolForm').textContent = school;
            if (isViewResult == 1) {
                document.getElementById('studentNameForm').textContent = localStorage.getItem('studentName') || '';
                document.getElementById('studentClassForm').textContent = localStorage.getItem('studentClass') || '';
            } else {
                document.getElementById('studentNameForm').textContent = '................................................................................';
                document.getElementById('studentClassForm').textContent = '................................................................................';
            }

            // Hàm render đề thi sau khi lấy xong dữ liệu
            function renderExam(questionss) {
                let questionList = '';
                if (questionss.length > 0) {
                    // Phân loại câu hỏi
                    const quizQuestions = questionss.filter(q => q.type === 'quiz' || q.type === 'Trắc nghiệm');
                    const essayQuestions = questionss.filter(q => q.type === 'essay' || q.type === 'tự luận');
                    const examType = localStorage.getItem('examType') || '';
                    if (isViewResult == 1) {
                        document.getElementsByClassName('bailam-title')[0].textContent = 'BÀI LÀM';
                    } else {
                        document.getElementsByClassName('bailam-title')[0].textContent = 'ĐỀ BÀI';
                    }
                    // Luôn hiển thị phần tự luận khi xem lại kết quả (isViewResult == 1)
                    if (examType === 'essay' || examType === 'tự luận') {
                        essayQuestions.forEach((ques, index) => {
                            questionList += `<div class="question">`;
                            questionList += `<p><b>Câu hỏi ${index + 1}: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b>${ques.question}</p>`;
                            if (isViewResult == 1 && ques.userAnswer) {
                                questionList += `<div style='margin: 8px 0 0 16px;'><b>Trả lời:</b> <span style='background: #f8f9fa; padding: 6px 12px; border-radius: 6px; color: #3498db;'>${ques.userAnswer}</span></div>`;
                            }
                            questionList += `</div>`;
                        });
                    } else if (examType === 'mix') {
                        if (quizQuestions.length > 0) {
                            questionList += `<div class='bailam-title' style='margin-top:24px;'>PHẦN 1: TRẮC NGHIỆM</div>`;
                            quizQuestions.forEach((ques, index) => {
                                questionList += `<div class="question">`;
                                questionList += `<p><b>Câu hỏi ${index + 1}: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b>${ques.question}</p>`;
                                questionList += `<ul class="options">`;
                                ques.options.forEach((opt, ind) => {
                                    let label = '';
                                    switch (ind) {
                                        case 0: label = 'A. '; break;
                                        case 1: label = 'B. '; break;
                                        case 2: label = 'C. '; break;
                                        case 3: label = 'D. '; break;
                                    }
                                    let cssClass = '';
                                    if (isViewResult == 1) {
                                        if (opt.id === ques.correctId) {
                                            cssClass = 'option-correct';
                                        }
                                        if (!ques.userAnswer || ques.userAnswer === null || ques.userAnswer === undefined || ques.userAnswer === '') {
                                            if (opt.id === ques.correctId) cssClass = 'option-correct-empty';
                                        } else if (opt.context === ques.userAnswer) {
                                            if (opt.id === ques.correctId) cssClass = 'option-correct';
                                            else cssClass = 'option-user';
                                        }
                                    }
                                    questionList += `<li class='${cssClass.trim()}'>${label}${opt.context}</li>`;
                                });
                                questionList += `</ul>`;
                                questionList += `</div>`;
                            });
                        }
                        if (essayQuestions.length > 0) {
                            questionList += `<div class='bailam-title' style='margin-top:24px;'>PHẦN 2: TỰ LUẬN</div>`;
                            essayQuestions.forEach((ques, index) => {
                                questionList += `<div class="question">`;
                                questionList += `<p><b>Câu hỏi ${index + 1}: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b>${ques.question}</p>`;
                                if (isViewResult == 1 && ques.userAnswer) {
                                    questionList += `<div style='margin: 8px 0 0 16px;'><b>Trả lời:</b> <span style='background: #f8f9fa; padding: 6px 12px; border-radius: 6px; color: #3498db;'>${ques.userAnswer}</span></div>`;
                                }
                                questionList += `</div>`;
                            });
                        }
                    } else {
                        // Đề trắc nghiệm: như cũ
                        quizQuestions.forEach((ques, index) => {
                            questionList += `<div class="question">`;
                            questionList += `<p><b>Câu hỏi ${index + 1}: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b>${ques.question}</p>`;
                            questionList += `<ul class="options">`;
                            ques.options.forEach((opt, ind) => {
                                let label = '';
                                switch (ind) {
                                    case 0: label = 'A. '; break;
                                    case 1: label = 'B. '; break;
                                    case 2: label = 'C. '; break;
                                    case 3: label = 'D. '; break;
                                }
                                let cssClass = '';
                                if (isViewResult == 1) {
                                    if (opt.id === ques.correctId) {
                                        cssClass = 'option-correct';
                                    }
                                    if (!ques.userAnswer || ques.userAnswer === null || ques.userAnswer === undefined || ques.userAnswer === '') {
                                        if (opt.id === ques.correctId) cssClass = 'option-correct-empty';
                                    } else if (opt.context === ques.userAnswer) {
                                        if (opt.id === ques.correctId) cssClass = 'option-correct';
                                        else cssClass = 'option-user';
                                    }
                                }
                                questionList += `<li class='${cssClass.trim()}'>${label}${opt.context}</li>`;
                            });
                            questionList += `</ul>`;
                            questionList += `</div>`;
                        });
                        // Nếu đang xem lại kết quả và có câu tự luận thì vẫn hiển thị phần tự luận
                        if (isViewResult == 1 && essayQuestions.length > 0) {
                            questionList += `<div class='bailam-title' style='margin-top:24px;'>PHẦN TỰ LUẬN</div>`;
                            essayQuestions.forEach((ques, index) => {
                                questionList += `<div class="question">`;
                                questionList += `<p><b>Câu hỏi ${index + 1}: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b>${ques.question}</p>`;
                                if (ques.userAnswer) {
                                    questionList += `<div style='margin: 8px 0 0 16px;'><b>Trả lời:</b> <span style='background: #f8f9fa; padding: 6px 12px; border-radius: 6px; color: #3498db;'>${ques.userAnswer}</span></div>`;
                                }
                                questionList += `</div>`;
                            });
                        }
                    }
                }
                let listQuestion = document.getElementById('list-question');
                listQuestion.innerHTML = questionList;
            }

            // Hàm khởi động: gọi API, show/hide loading, render giao diện
            async function initExamView() {
                document.getElementById('modalLoading').style.display = 'flex';
                document.getElementById('exam-content').style.display = 'none';
                let questionss = [];
                if (isViewResult == 1) {
                    let examId = localStorage.getItem('examId') || '';
                    let subjectId = localStorage.getItem('subject') || '';
                    let resultId = localStorage.getItem('resultId') || '';
                    
                    const url = `${ggApiUrl}?action=getExamWithAnswer&examId=${encodeURIComponent(examId)}&subject=${encodeURIComponent(subjectId)}&resultId=${encodeURIComponent(resultId)}`;
                    try {
                        const res = await fetch(url);
                        const data = await res.json();
                        // Gán userAnswer cho từng câu hỏi nếu có trường answer từ API
                        if (Array.isArray(data.list) && Array.isArray(data.answer)) {
                            const answerMap = {};
                            data.answer.forEach(a => {
                                if (a.questionId) answerMap[a.questionId] = a.userAnswer;
                            });
                            data.list = data.list.map(q => {
                                return { ...q, userAnswer: answerMap[q.id] || q.userAnswer || '' };
                            });
                        }
                        let newQuestions = generatedOptions(data.list);
                        let generatedQuestions = generateExamFromQuestions(newQuestions, data.total, data.form, data.type);

                        questionss = generatedQuestions || [];
                        localStorage.setItem('questions', JSON.stringify(questionss));
                        renderExam(questionss);
                        // Hiển thị điểm nếu có
                        if (typeof data.point !== 'undefined') {
                            document.getElementById('studentPoint').textContent = data.point;
                            document.getElementById('pointView').style.display = 'block';
                        }
                    } catch (err) {
                        questionss = [];
                    }
                } else if (isViewResult == 0) {
                    questionss = JSON.parse(localStorage.getItem('questions')) || [];
                    renderExam(questionss);
                    document.getElementById('pointView').style.display = 'none';
                }
                document.getElementById('modalLoading').style.display = 'none';
                document.getElementById('exam-content').style.display = 'block';
            }

            window.addEventListener('DOMContentLoaded', initExamView);

            function downloadPDF() {
                const element = document.getElementById('exam-content');
                let fileName = '';
                if (isViewResult == 1) {
                    fileName = localStorage.getItem('examName') + ' - ' + localStorage.getItem('studentName') + '.pdf';
                } else {
                    fileName = localStorage.getItem('examName') + '.pdf';
                }
                const opt = {
                    margin: 0.5,
                    filename: fileName,
                    image: { 
                        type: 'jpeg', 
                        quality: 0.98 
                    },
                    html2canvas:  {
                        scale: 1.5,
                        scrollY: 0
                    },
                    jsPDF: {
                        unit: 'in',
                        format: 'a4',
                        orientation: 'portrait'
                    }
                };

                // Cho delay 100ms để đảm bảo DOM render xong
                setTimeout(() => {
                    html2pdf().set(opt).from(element).save();
                }, 100);
            }
        </script>
    </body>
</html>